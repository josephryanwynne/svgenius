<!DOCTYPE html>
<html>
    <head>
    <style type="text/css">
        
        div, svg {
        
            border: 1px solid black;
        }
        
        
    </style>
    
    </head>
<body>
<!--

TODO
====

* Issues with stroke lines at top and bottom of the image. It should probably always start at 1px in, or use radius which is 1px less than half of the available space
* When doing the above, the overlay is no longer correctly positioned. WHY THE FUCK NOT.

-->
    
<div id="gaugeContainer1" height="200" width="200"></div>
<div id="gaugeContainer2" height="400" width="400"></div>
<div id="gaugeContainer3" height="600" width="600"></div>
    
<script type="text/javascript">

document.onreadystatechange = function(){
    
    
if (document.readyState == "interactive") {
//Create the namespace to begin with
    
//SVGENIUS... the beginning of something beautiful.
var SVGENIUS = SVGENIUS || {};
SVGENIUS.charts = {
    gauge: function(conf){
        
        var gaugeContainer = document.getElementById(conf.targetContainerId);
        
        var height = gaugeContainer.getAttribute("height"); // Probably need to work out how much space we have dynamically. Get dimensions of containing div?
        var width = gaugeContainer.getAttribute("width"); // Same for this value
        
        console.log(height + " " + width);
        var strokeWidth = 1;
        
        var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute('xmlns:svg',"http://www.w3.org/2000/svg");
        svg.setAttribute('xmlns', "http://www.w3.org/2000/svg");
        svg.setAttribute('height', height);
        svg.setAttribute('width', width);
        
        
        var gaugeWidth = 25; //Arbitrary... Maybe it could be configurable
        var radius = height / 2.0 - 5; // This should be based on how much space we have. Something like height / 2 ?? take something off to avoid overlap
        var innerRadius = radius - gaugeWidth;
        
        console.log('innerRadius[' + innerRadius + '] outerRadius['+radius+']');
        var startX = radius;
        var startY = gaugeWidth+1; //This is a bad idea. Use a cental point as a starting point instead? 
        
        //Grey outline of the gauge - draw vertical line up, outer arc, up, inner arc.
        var outline = document.createElementNS("http://www.w3.org/2000/svg", "path");
        outline.setAttribute('d', 'M'+startX+','+startY+' v-' + gaugeWidth + ' A1,1 0 0 1 '+startX+' '+(2*radius)+' v-'+gaugeWidth+' A1,1 0 0 0 '+startX+','+startY+' Z');
        outline.setAttribute('fill', 'none');
        outline.setAttribute('stroke', 'grey');
        outline.setAttribute('stroke-width', '1');
                
        var halfwayPoint = (startX+radius-(strokeWidth/2))+','+(radius+1); // Check that this is correct
        var percentageDifference = conf.percentageDifference; // Exactly halfway in the top section -- same as in testing
        
        console.log('halfwayPoint['+halfwayPoint+']');
        
        var halfwayMarker = document.createElementNS("http://www.w3.org/2000/svg", "path");
        halfwayMarker.setAttribute('d', 'M'+halfwayPoint+' h 10 h -'+(gaugeWidth+10+10)+' Z');
        halfwayMarker.setAttribute('stroke', 'grey');
        halfwayMarker.setAttribute('stroke-width', '1');
        
        var angle = Math.PI / (200 / percentageDifference);
        var outerArcYOffset = radius * Math.sin(angle);
        var outerArcXOffset = radius * Math.cos(angle);
        var innerArcYOffset = (radius - gaugeWidth) * Math.sin(angle);
        var innerArcXOffset = (radius - gaugeWidth) * Math.cos(angle);
        
        console.log('offsets ['+innerArcXOffset+','+innerArcYOffset+'] ['+outerArcXOffset+','+outerArcYOffset+']');
        
        var innerArcFlag = percentageDifference > 0 ? 0 : 1;
        var outerArcFlag = percentageDifference > 0 ? 1 : 0;
        var correction = percentageDifference > 0 ? 1 : 0;
        
        var overlay = document.createElementNS("http://www.w3.org/2000/svg", "path");
        overlay.setAttribute('d', 'M'+halfwayPoint+' l-'+(gaugeWidth)+',0 A'+innerRadius+','+innerRadius+' 0 0 '+innerArcFlag+' '+(radius+innerArcXOffset)+','+(radius-innerArcYOffset+correction)+'  L'+(radius+outerArcXOffset)+','+(radius-outerArcYOffset+correction)+' A'+radius+','+radius+' 0 0 '+outerArcFlag+' '+halfwayPoint);
        overlay.setAttribute('fill', (Math.abs(percentageDifference)>conf.threshold?'red':'green'));
        overlay.setAttribute('stroke-width', '0');
        
        //Add the things to the page
        gaugeContainer.appendChild(svg);
        
        svg.appendChild(overlay);
        svg.appendChild(outline);
        svg.appendChild(halfwayMarker);
    }
}
    
    //Configuration for the chart
    SVGENIUS.charts.gauge({
        targetContainerId: "gaugeContainer1",
        text: "50%<br/>Ahead", //Not yet used
        percentageDifference: 1,
        threshold: 10
    });
    
    //Configuration for the chart
    SVGENIUS.charts.gauge({
        targetContainerId: "gaugeContainer2",
        text: "50%<br/>Ahead", //Not yet used
        percentageDifference: -98,
        threshold: 10
    });
    
    SVGENIUS.charts.gauge({
        targetContainerId: "gaugeContainer3",
        text: "50%<br/>Ahead", //Not yet used
        percentageDifference: -60,
        threshold: 10
    });
}
}

</script>
    SOH
    CAH
    TOA
</body>
</html>
